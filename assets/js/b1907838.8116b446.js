"use strict";(self.webpackChunk_dev_lambda_api_template_doc=self.webpackChunk_dev_lambda_api_template_doc||[]).push([[891],{876:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>g});var r=n(2784);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=r.createContext({}),c=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},p=function(e){var t=c(e.components);return r.createElement(s.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=c(n),d=o,g=u["".concat(s,".").concat(d)]||u[d]||m[d]||i;return n?r.createElement(g,a(a({ref:t},p),{},{components:n})):r.createElement(g,a({ref:t},p))}));function g(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,a=new Array(i);a[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:o,a[1]=l;for(var c=2;c<i;c++)a[c]=n[c];return r.createElement.apply(null,a)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},3468:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>a,default:()=>m,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var r=n(7896),o=(n(2784),n(876));const i={sidebar_position:8},a="Monitoring",l={unversionedId:"contribute/monitoring",id:"contribute/monitoring",title:"Monitoring",description:"Logs",source:"@site/docs/contribute/monitoring.md",sourceDirName:"contribute",slug:"/contribute/monitoring",permalink:"/api-template/docs/contribute/monitoring",draft:!1,editUrl:"https://github.com/dev-lambda/api-template/edit/main/website/docs/contribute/monitoring.md",tags:[],version:"current",sidebarPosition:8,frontMatter:{sidebar_position:8},sidebar:"tutorialSidebar",previous:{title:"Build, Publish and Deploy",permalink:"/api-template/docs/contribute/deployment"}},s={},c=[{value:"Logs",id:"logs",level:2},{value:"API logs",id:"api-logs",level:3},{value:"Using logs",id:"using-logs",level:3},{value:"Log collection",id:"log-collection",level:3},{value:"Application metrics",id:"application-metrics",level:2},{value:"Default metrics",id:"default-metrics",level:3},{value:"Custom metrics",id:"custom-metrics",level:3},{value:"Dashboard",id:"dashboard",level:3}],p={toc:c},u="wrapper";function m(e){let{components:t,...n}=e;return(0,o.kt)(u,(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"monitoring"},"Monitoring"),(0,o.kt)("h2",{id:"logs"},"Logs"),(0,o.kt)("p",null,"Logs are timestamped and output in json format to the standard output."),(0,o.kt)("p",null,"Example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{"level":"info","message":"Starting server","timestamp":"2023-05-09T14:02:03.995Z"}\n{"address":"::","family":"IPv6","level":"info","message":"Server started","port":3000,"timestamp":"2023-05-09T14:02:04.010Z"}\n{"level":"info","message":"Connected to db","timestamp":"2023-05-09T14:02:04.010Z"}\n{"httpVersion":"1.1","length":"9260","level":"info","message":"GET /metrics 200","method":"GET","remoteAddr":"::ffff:127.0.0.1","responseTime":5,"status":"200","timestamp":"2023-05-09T14:02:05.490Z","url":"/metrics"}\n')),(0,o.kt)("h3",{id:"api-logs"},"API logs"),(0,o.kt)("p",null,"All api calls are logged using the following informations extracted from morgan library:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/logger.ts"',title:'"src/logger.ts"'},"  const info = {\n    remoteAddr,\n    user,\n    method,\n    url,\n    httpVersion,\n    status,\n    length,\n    responseTime,\n  };\n")),(0,o.kt)("h3",{id:"using-logs"},"Using logs"),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Describe as much as possible the message in terms of the actual work that your function is responsible for. You can add details as long as they are pertinent for the situation you are handling.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"import logger from 'src/logger';\n\nlogger.debug('configuration used', resolvedConfigObject);\n\nlogger.info('application started');\n\nlogger.warn('something is fishy while doing [work]. The expected [invariant] is not in an expected state', {myInvariantStatus})\n\nlogger.error('[my function] failed to execute', err);\n")),(0,o.kt)("p",null,"In order to locally force a given debug level:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"logLevel=debug npm run watch\n")),(0,o.kt)("h3",{id:"log-collection"},"Log collection"),(0,o.kt)("p",null,"Not set up yet. Depends on deployment."),(0,o.kt)("h2",{id:"application-metrics"},"Application metrics"),(0,o.kt)("p",null,"Prometheus metrics are exposed at ",(0,o.kt)("inlineCode",{parentName:"p"},"/metrics")," endpoint."),(0,o.kt)("h3",{id:"default-metrics"},"Default metrics"),(0,o.kt)("p",null,"Default exposed metrics:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"http_request_duration_milliseconds")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"http_request_count")),(0,o.kt)("li",{parentName:"ul"},"prometheus default metrics")),(0,o.kt)("p",null,"The first two track the same information used for API logging. The last is the standard metrics provided by the ",(0,o.kt)("inlineCode",{parentName:"p"},"prom-client")," library."),(0,o.kt)("h3",{id:"custom-metrics"},"Custom metrics"),(0,o.kt)("p",null,"Example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="Define a custom counter"',title:'"Define',a:!0,custom:!0,'counter"':!0},"import Prometheus from 'prom-client';\n\n// Register a custom counter to keep track of application activity.\n// In this example the `type` label is used to track a counter per specific activity type for the application activity being followed.\nconst activityCounter = new Prometheus.Counter({\n  name: 'myCounter',\n  help: 'Count of HTTP requests made to my app',\n  labelNames: ['type'],\n});\n\nPrometheus.register.registerMetric(activityCounter);\n\n// [...]\n\n// use the counter at the appropriate level (controller, service, ...)\nactivityCounter\n  .labels({\n    type: 'userMessage' // this could be anything: fileGeneration, message type, ...\n  })\n  .inc();\n")),(0,o.kt)("p",null,"For more metric types check the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/siimon/prom-client#custom-metrics"},(0,o.kt)("inlineCode",{parentName:"a"},"prom-client")," library documentation"),"."),(0,o.kt)("h3",{id:"dashboard"},"Dashboard"),(0,o.kt)("p",null,"Not set up yet. Depends on deployment."))}m.isMDXComponent=!0}}]);